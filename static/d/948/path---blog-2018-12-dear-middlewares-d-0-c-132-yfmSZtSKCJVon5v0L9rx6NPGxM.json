{"data":{"site":{"siteMetadata":{"title":"Meha Masum","author":"Meha Masum","fbAppId":"575960529519073","blogTitle":"Learning in public","blogSlogan":"Meha Masum's Personal Blog","siteUrl":"https://mehamasum.github.io"}},"markdownRemark":{"id":"06c5997c-003d-5033-b93c-126648dc4bf1","timeToRead":9,"excerpt":"This is a common structure of every redux middleware:When I first started, it really intimidated me- what’s with all those arrows? Then of…","html":"<p>This is a common structure of every redux middleware:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">middleware</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When I first started, it really intimidated me- what’s with all those arrows? Then of course when I got to know them a little bit better, it was pretty clear. That’s what we will try to do in this post. We will start from ground up and reach that <code class=\"language-text\">store =&gt; next =&gt; action =&gt;</code> thingy gradually.</p>\n<p>If you are familiar with the concept of middleware you can skip the next section and go directly to <a href=\"#redux-middleware\">Redux’s version of middleware</a>.</p>\n<h2 id=\"what-is-middleware-anyway\"><a href=\"#what-is-middleware-anyway\" aria-label=\"what is middleware anyway permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is middleware, anyway?</h2>\n<p>In general, middleware is some code you can put in between some other code (hence the name).</p>\n<p>For example, when a server-side library receives a request at a particular endpoint, the associated “view” function will generate a response in return. Now you may wish to “log” every request it receives. Instead of logging the request manually in each endpoint’s “view” function, you can put a middleware in between the code of receiving a request and generating a response.</p>\n<p>Similarly if you want to parse the “body” of the request you don’t want to do that in every function. You may add a middleware that parses the body of each request so that your “view”s get already parsed (“ready made”) body to work with.</p>\n<p>Another popular use case would be, one middleware checks the authentication credentials of the request and put the user details in that “request object”- so that every response generator function doesn’t have to make a DB call to find out who the request came from. There could be many more of these. And the best part is- you can chain them after one another. Here is a conceptual view:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/344b2912c7f67e2f762cfa97cbc4701a/f73cf/example.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 14.423076923076922%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7CAAAOwgEVKEqAAAAAi0lEQVQI102Niw7CIAxF9/+fueiMMt7YAkOuwJixSdO0OT13EX4DJwZxQiCGth7K+HbL46aMg9IWPhAoptGdMS4gHwWltFYbiljxIYfl5e7gTMi5DEhIjV1ZcOzCCDMC3BDGGWKch2whb4qIzDi6cJ9C/FWtdc5z10203h4j5CkkUhNeXGcu/vfQ6gv7sui/dnWv2wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"example\"\n        title=\"\"\n        src=\"/static/344b2912c7f67e2f762cfa97cbc4701a/b9e4f/example.png\"\n        srcset=\"/static/344b2912c7f67e2f762cfa97cbc4701a/cf440/example.png 148w,\n/static/344b2912c7f67e2f762cfa97cbc4701a/d2d38/example.png 295w,\n/static/344b2912c7f67e2f762cfa97cbc4701a/b9e4f/example.png 590w,\n/static/344b2912c7f67e2f762cfa97cbc4701a/f9b6a/example.png 885w,\n/static/344b2912c7f67e2f762cfa97cbc4701a/f73cf/example.png 1040w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2 id=\"redux-middleware\"><a href=\"#redux-middleware\" aria-label=\"redux middleware permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux middleware</h2>\n<blockquote>\n<p>Redux middleware provides a third-party extension point between dispatching an action, and the moment it reaches the reducer.</p>\n</blockquote>\n<p>Let’s think about that for a minute. Like any other middleware, it sits between two points. In this case, between dispatching an action (<code class=\"language-text\">store.dispatch</code> call) and the action reaching the reducers (for state update).</p>\n<p>So here is a conceptual view:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0bb8698966e2249bef195754c5e0ccd7/17fa4/redux-middleware.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 13.043478260869565%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7CAAAOwgEVKEqAAAAAh0lEQVQI101OQQ7CMAzb/3+IxAEk2ARcika7tklqnDAQkazEruN0UhNstaFsDWoDooYmSl7xKhWdsxDeM7VMrXWh18Lr3Pc1J1i6YXqsM0orEVhbD7jB4bPoJywOkbuv7G9fj/Ejxgxj6IS9XPSrAS57zcsdh+MJV/bzZUF6rqH/fMQYA//1Blca6nXnRlqoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"redux middleware\"\n        title=\"\"\n        src=\"/static/0bb8698966e2249bef195754c5e0ccd7/b9e4f/redux-middleware.png\"\n        srcset=\"/static/0bb8698966e2249bef195754c5e0ccd7/cf440/redux-middleware.png 148w,\n/static/0bb8698966e2249bef195754c5e0ccd7/d2d38/redux-middleware.png 295w,\n/static/0bb8698966e2249bef195754c5e0ccd7/b9e4f/redux-middleware.png 590w,\n/static/0bb8698966e2249bef195754c5e0ccd7/f9b6a/redux-middleware.png 885w,\n/static/0bb8698966e2249bef195754c5e0ccd7/17fa4/redux-middleware.png 1035w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>But why does it sit there? Consider these use cases:</p>\n<ul>\n<li>\n<p>We want to log every action that is dispatched and how that action changed the state. That way, when something is wrong we can look back at our log and figure out which action is responsible for putting our app in a bad state. We have to put this logger between those two points to achieve this.</p>\n</li>\n<li>\n<p>We want to have a common error catching logic for our app (and possibly send it to a crash reporting service).</p>\n</li>\n</ul>\n<p>Now let’s forget everything about the <code class=\"language-text\">store =&gt; next =&gt; action =&gt;</code> thing we saw before and try to write a redux middleware from scratch.</p>\n<h2 id=\"writing-middleware-from-scratch\"><a href=\"#writing-middleware-from-scratch\" aria-label=\"writing middleware from scratch permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Writing middleware from scratch</h2>\n<p>Let’s say we want to have log functionality like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\nstore<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But we don’t want to write a bunch of <code class=\"language-text\">console.log</code> every time we write a <code class=\"language-text\">dispatch</code> call.</p>\n<p>So what else can we do?\nWe could write our own version of dispatch (which is basically a wrapper) and call it every time.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">ourDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n  store<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So every time we want to dispatch an action, we call <code class=\"language-text\">ourDispatch</code> instead of <code class=\"language-text\">store.dispatch</code>. But this will probably cause inconsistency in our project if we call <code class=\"language-text\">store.dispatch</code> in some files and <code class=\"language-text\">ourDispatch</code> in some others. We need a better solution.</p>\n<p>Can we not modify <code class=\"language-text\">store.dispatch</code> itself?</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> originalDispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\nstore<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ourDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">originalDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> originalReturnValue\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here we copied the original version of <code class=\"language-text\">store.dispatch</code> to <code class=\"language-text\">originalDispatch</code>. Then we assign it our own definition. The original one take one argument (<code class=\"language-text\">action</code>), so does ours. We also return the <code class=\"language-text\">originalReturnValue</code>. May be, we do not know what original <code class=\"language-text\">store.dispatch</code> was supposed to return, but we don’t want to pollute it’s old signature.</p>\n<p>So we got what we wanted. But this is a bad approach. Because we are modifying things at our will, but we know things should only be <a href=\"https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle\">extended not modified</a>. But let’s keep it like this for a while.</p>\n<h3 id=\"chaining-middlewares\"><a href=\"#chaining-middlewares\" aria-label=\"chaining middlewares permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chaining middlewares</h3>\n<p>An important feature of middleware is chaining. How can we do that with what we have written so far?</p>\n<p>Let’s say we want to add a common error catching behavior. That is- we want a common place where we can catch any thrown error.</p>\n<p>We will modify <code class=\"language-text\">dispatch</code> one more time:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> originalDispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\nstore<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ourDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">originalDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> originalReturnValue\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// now store.dispatch is modified</span>\n<span class=\"token comment\">// let's modify it one more time</span>\n<span class=\"token keyword\">const</span> modifiedDispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\nstore<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ourNewDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">modifiedDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> originalReturnValue\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Caught an exception!'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">throw</span> err\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We just copied and pasted the previous implementation of middleware. This would work. Every time we want to chain some more middleware, we keep copy and pasting in this format.</p>\n<p>This works, but what if we decide our middlewares will no longer reside in a single file? Ideally such new functions will be in separate modules and might even come from third party packages. To facilitate that we should make <code class=\"language-text\">store</code> a parameter. That way we can send <code class=\"language-text\">store</code> and those middlewares would replace the <code class=\"language-text\">store.dispatch</code> with their own implementation.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// in one file/package</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">patchStoreToAddLogging</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> currentDispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n  store<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ourDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">currentDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> originalReturnValue\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// in different file/package</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">store</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> currentDispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch\n  store<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ourNewDispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">currentDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> originalReturnValue\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Caught an exception!'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">throw</span> err\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now even if these functions are published as separate modules, we can call them easily after one another:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// after import from files/packages</span>\n<span class=\"token function\">patchStoreToAddLogging</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span>\n<span class=\"token function\">patchStoreToSupportErrorHandling</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Good, now we have chained middlewares.</p>\n<h3 id=\"better-implementation\"><a href=\"#better-implementation\" aria-label=\"better implementation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Better implementation</h3>\n<p>Now let’s go back to our previous problem. We don’t want to modify the library function <code class=\"language-text\">store.dispatch</code> like this. What else could we do? Instead of modifying the current version ‘in-place’, we could just return the new version of the <code class=\"language-text\">store.dispatch</code>. This technique is actually called <a href=\"https://stackoverflow.com/questions/36314/what-is-currying\">Currying</a> and pretty common in JS.</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">export function patchStoreToAddLogging(store) {\n  const currentDispatch = store.dispatch\n<span class=\"token deleted\">- store.dispatch = function ourDispatch(action) {</span>\n<span class=\"token inserted\">+ return function ourDispatch(action) {</span>\n    console.log('dispatching', action)\n    let originalReturnValue = currentDispatch(action)\n    console.log('new state', store.getState())\n    return originalReturnValue\n  }\n}\n\nexport function patchStoreToSupportErrorHandling(store) {\n  const currentDispatch = store.dispatch\n<span class=\"token deleted\">- store.dispatch = function ourNewDispatch(action) {</span>\n<span class=\"token inserted\">+ return function ourNewDispatch(action) {</span>\n    try {\n      let originalReturnValue = currentDispatch(action)\n      return originalReturnValue\n    } catch (err) {\n      console.error('Caught an exception!', err)\n      throw err\n    }\n  }\n}</code></pre></div>\n<p>What good did it do? :/<br>\nHow would we ‘chain’ them without assigning them to <code class=\"language-text\">store.dispatch</code> like this?</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">store<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token function\">patchStoreToAddLogging</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span>\nstore<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token function\">patchStoreToSupportErrorHandling</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span></code></pre></div>\n<p>If we want to avoid assigning, in order to ‘chain’ them we have to pass the current version of <code class=\"language-text\">store.dispatch</code> to each of them as argument. That way, the first function will get the original <code class=\"language-text\">store.dispatch</code> and return a new version of <code class=\"language-text\">store.dispatch</code>. This will go as argument to the second function so that can return a further modified version. Eventually we will receive a fully changed version of <code class=\"language-text\">store.dispatch</code>. Instead of changing <code class=\"language-text\">store.dispatch</code> itself we will create a copy of store at setup time with the last fully changed version of <code class=\"language-text\">dispatch</code>.</p>\n<p>So the final version of those two functions will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">export function patchStoreToAddLogging(store) {\n<span class=\"token deleted\">-  const currentDispatch = store.dispatch</span>\n<span class=\"token inserted\">+  return function wrapDispatch(currentDispatch) {</span>\n    return function ourDispatch(action) {\n      console.log('dispatching', action)\n      let originalReturnValue = currentDispatch(action)\n      console.log('new state', store.getState())\n      return originalReturnValue\n    }\n<span class=\"token inserted\">+  }</span>\n}\n\nexport function patchStoreToSupportErrorHandling(store) {\n<span class=\"token deleted\">-  const currentDispatch = store.dispatch</span>\n<span class=\"token inserted\">+  return function wrapDispatch(currentDispatch) {</span>\n    return function ourNewDispatch(action) {\n      try {\n        let originalReturnValue = currentDispatch(action)\n        return originalReturnValue\n      } catch (err) {\n        console.error('Caught an exception!', err)\n        throw err\n      }\n    }\n<span class=\"token inserted\">+  }</span>\n}</code></pre></div>\n<p>Just one line of change in each function: <code class=\"language-text\">currentDispatch</code> now comes as a argument, not from <code class=\"language-text\">store</code>. This allows us to apply the desired chaining without assigning every time. With this we would get a new copy of <code class=\"language-text\">store</code> object when we set things up at the beginning and work with that.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">let</span> dispatch <span class=\"token operator\">=</span> store<span class=\"token punctuation\">.</span>dispatch <span class=\"token comment\">// original one</span>\ndispatch <span class=\"token operator\">=</span> <span class=\"token function\">patchStoreToAddLogging</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span>\ndispatch <span class=\"token operator\">=</span> <span class=\"token function\">patchStoreToSupportErrorHandling</span><span class=\"token punctuation\">(</span>store<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>dispatch<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> newStore <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> dispatch <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Of course we could loop over an array and still get that final fully wrapped <code class=\"language-text\">dispatch</code>.</p>\n<p>There we have it. We got a <code class=\"language-text\">store</code> object for our app with both middleware installed.</p>\n<h3 id=\"reduxs-applymiddleware\"><a href=\"#reduxs-applymiddleware\" aria-label=\"reduxs applymiddleware permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Redux’s applyMiddleware()</h3>\n<p>Redux provides an utility called <code class=\"language-text\">applyMiddleware</code> that would take care of calling our functions while setting up a store. <code class=\"language-text\">createStore</code> takes an optional last argument for this purpose.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> appliedMiddlewares <span class=\"token operator\">=</span> <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span>\n  patchStoreToAddLogging<span class=\"token punctuation\">,</span>\n  patchStoreToSupportErrorHandling\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span><span class=\"token function\">combineReducers</span><span class=\"token punctuation\">(</span>reducers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> appliedMiddlewares<span class=\"token punctuation\">)</span></code></pre></div>\n<p>It will apply the middlewares and return to us the final version of <code class=\"language-text\">store</code>.</p>\n<h3 id=\"almost-there\"><a href=\"#almost-there\" aria-label=\"almost there permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Almost there</h3>\n<p>Now lets take a look again our middlewares. With ES6 arrow function they would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">patchStoreToAddLogging</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">currentDispatch</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dispatching'</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">currentDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'new state'</span><span class=\"token punctuation\">,</span> store<span class=\"token punctuation\">.</span><span class=\"token function\">getState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> originalReturnValue\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">patchStoreToSupportErrorHandling</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">currentDispatch</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> originalReturnValue <span class=\"token operator\">=</span> <span class=\"token function\">currentDispatch</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> originalReturnValue\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Caught an exception!'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">throw</span> err\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Traditionally <code class=\"language-text\">currentDispatch</code> is often named <code class=\"language-text\">next</code> (as this version of dispatch will be called next inside a middleware) and middlewares would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">middleware</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I hope now you understand why there is that <code class=\"language-text\">store =&gt; next =&gt; action</code> thingy in every redux middleware.</p>\n<h3 id=\"we-must-return\"><a href=\"#we-must-return\" aria-label=\"we must return permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>We must return</h3>\n<p>I have seen a lot of tutorials online and several npm package’s source code that ship with middlewares that we can use in our projects and found out one crucial mistake in many such codes:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">middleware</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">store</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">next</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span> <span class=\"token comment\">// we _must_ return!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>They just call <code class=\"language-text\">next</code> but doesn’t return the value. It has <strong>bad side effects</strong>:</p>\n<p>As middlewares are chained together, if one of them forgets to return the value of <code class=\"language-text\">next</code> call, it will return <code class=\"language-text\">undefined</code> to the previous caller. There are many cases (specially with Async operations), where the return value is very important of the caller of <code class=\"language-text\">dispatch</code>. I intend to write another blog post with a case study about this.</p>\n<p>See you next time.</p>\n<h2 id=\"further-reading\"><a href=\"#further-reading\" aria-label=\"further reading permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Further reading</h2>\n<ul>\n<li><a href=\"https://hackernoon.com/currying-in-js-d9ddc64f162e\">Currying in JS</a></li>\n<li><a href=\"https://redux.js.org/advanced/middleware#seven-examples\">7 examples of redux middlewares</a></li>\n</ul>","tableOfContents":"<ul>\n<li><a href=\"/blog/2018/12/dear-middlewares/#what-is-middleware-anyway\">What is middleware, anyway?</a></li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#redux-middleware\">Redux middleware</a></li>\n<li>\n<p><a href=\"/blog/2018/12/dear-middlewares/#writing-middleware-from-scratch\">Writing middleware from scratch</a></p>\n<ul>\n<li><a href=\"/blog/2018/12/dear-middlewares/#chaining-middlewares\">Chaining middlewares</a></li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#better-implementation\">Better implementation</a></li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#reduxs-applymiddleware\">Redux’s applyMiddleware()</a></li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#almost-there\">Almost there</a></li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#we-must-return\">We must return</a></li>\n</ul>\n</li>\n<li><a href=\"/blog/2018/12/dear-middlewares/#further-reading\">Further reading</a></li>\n</ul>","frontmatter":{"title":"Lets know redux middlewares better","date":"December 21, 2018","tags":["middleware","reduxjs"],"category":"General","thumbnail":"/images/posts/redux.png","spoiler":"Does redux middleware confuse you? Take a deep breath and read on."}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/blog/2018/12/dear-middlewares/","previousPage":{"id":"ba1e524a-8d7e-5bcf-9357-5a2af6c6492b","excerpt":"Problem description can be found here (Part 3: Paint shop synchronization)In this article I’m going to assume:You have already set up and…","fields":{"slug":"/blog/2016/06/paintshop-solution/"},"timeToRead":2,"frontmatter":{"date":"June 26, 2016","title":"OS/161: Paint Shop Synchronization Problem","tags":["os161"],"category":"Academic","thumbnail":"https://mehamasum.files.wordpress.com/2016/06/paintshop.png","spoiler":"Ideas (and code) to solve OS/161 Coding Assignment Part 3: Paint shop synchronization."}},"nextPage":{"id":"62bda22d-164d-54bc-a206-3e896525ab52","excerpt":"আজকে আমরা First-Class Functions নিয়ে কথা বলব।\nউদাহরণগুলো পাইথনে লেখা, কিন্তু যদি একটা ভাষায় ফাংশন First-Class…","fields":{"slug":"/blog/2019/5/first-class-functions/"},"timeToRead":9,"frontmatter":{"date":"May 27, 2019","title":"First-Class Functions - পাইথনে ক্লিন কোড","tags":["python"],"category":"Native","thumbnail":"/images/posts/py.png","spoiler":"First-Class Functions কি এবং কেন- উদাহরণ ও অনুশীলন।"}}}}